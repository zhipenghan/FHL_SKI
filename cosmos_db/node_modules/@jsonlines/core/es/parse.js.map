{"version":3,"file":"parse.js","sources":["../../src/parse.ts"],"sourcesContent":["import { AsyncDuplexBase } from \"./util/duplex-base\";\nimport {\n  ReadLineStream,\n  ReadLineStreamOptions,\n  LineParser,\n} from \"./readline-stream\";\nimport { nullValue } from \"./null-value\";\n\nexport type JsonLinesGzipOption = boolean | import(\"zlib\").ZlibOptions;\n\nexport interface JsonLinesParseOptions<V> extends ReadLineStreamOptions<V> {\n  gzip?: JsonLinesGzipOption;\n}\n\nfunction wrapParseFunc<V>(parse: LineParser<V>): LineParser<V> {\n  return (line) =>\n    Promise.resolve(parse(line)).then((s) => {\n      if (s === null) return nullValue as never;\n      else return s;\n    });\n}\n\nexport class JsonLinesParseStream<V = unknown> extends AsyncDuplexBase {\n  constructor(options?: JsonLinesParseOptions<V>) {\n    const gzip = options?.gzip;\n\n    const readline = new ReadLineStream({\n      encoding: options?.encoding,\n      lineSep: options?.lineSep ?? \"lf\",\n      parse: wrapParseFunc(options?.parse ?? JSON.parse),\n    });\n\n    super(\n      {\n        writable: gzip\n          ? () =>\n              import(\"zlib\").then((zlib) => {\n                const gunzip = zlib.createGunzip(\n                  gzip === true ? undefined : gzip,\n                );\n\n                gunzip.pipe(readline);\n\n                return gunzip;\n              })\n          : readline,\n        readable: readline,\n      },\n      { readableObjectMode: true, writableObjectMode: false },\n    );\n  }\n}\n\nexport function parse(\n  ...args: ConstructorParameters<typeof JsonLinesParseStream>\n): JsonLinesParseStream {\n  return new JsonLinesParseStream(...args);\n}\n"],"names":["wrapParseFunc","parse","line","Promise","resolve","then","s","nullValue","JsonLinesParseStream","AsyncDuplexBase","constructor","options","gzip","readline","ReadLineStream","encoding","lineSep","JSON","writable","zlib","gunzip","createGunzip","undefined","pipe","readable","readableObjectMode","writableObjectMode","args"],"mappings":";;;;;;;;;AAcA,SAASA,aAAT,CAA0BC,KAA1B;AACE,SAAQC,IAAD,IACLC,OAAO,CAACC,OAAR,CAAgBH,KAAK,CAACC,IAAD,CAArB,EAA6BG,IAA7B,CAAmCC,CAAD;AAChC,QAAIA,CAAC,KAAK,IAAV,EAAgB,OAAOC,SAAP,CAAhB,KACK,OAAOD,CAAP;AACN,GAHD,CADF;AAKD;;MAEYE,6BAA0CC;AACrDC,EAAAA,YAAYC;;;AACV,UAAMC,IAAI,GAAGD,OAAH,aAAGA,OAAH,uBAAGA,OAAO,CAAEC,IAAtB;AAEA,UAAMC,QAAQ,GAAG,IAAIC,cAAJ,CAAmB;AAClCC,MAAAA,QAAQ,EAAEJ,OAAF,aAAEA,OAAF,uBAAEA,OAAO,CAAEI,QADe;AAElCC,MAAAA,OAAO,sBAAEL,OAAF,aAAEA,OAAF,uBAAEA,OAAO,CAAEK,OAAX,+DAAsB,IAFK;AAGlCf,MAAAA,KAAK,EAAED,aAAa,mBAACW,OAAD,aAACA,OAAD,uBAACA,OAAO,CAAEV,KAAV,2DAAmBgB,IAAI,CAAChB,KAAxB;AAHc,KAAnB,CAAjB;AAMA,UACE;AACEiB,MAAAA,QAAQ,EAAEN,IAAI,GACV,MACE,OAAO,MAAP,EAAeP,IAAf,CAAqBc,IAAD;AAClB,cAAMC,MAAM,GAAGD,IAAI,CAACE,YAAL,CACbT,IAAI,KAAK,IAAT,GAAgBU,SAAhB,GAA4BV,IADf,CAAf;AAIAQ,QAAAA,MAAM,CAACG,IAAP,CAAYV,QAAZ;AAEA,eAAOO,MAAP;AACD,OARD,CAFQ,GAWVP,QAZN;AAaEW,MAAAA,QAAQ,EAAEX;AAbZ,KADF,EAgBE;AAAEY,MAAAA,kBAAkB,EAAE,IAAtB;AAA4BC,MAAAA,kBAAkB,EAAE;AAAhD,KAhBF;AAkBD;;;SAGazB,MACd,GAAG0B;AAEH,SAAO,IAAInB,oBAAJ,CAAyB,GAAGmB,IAA5B,CAAP;AACD;;;;"}